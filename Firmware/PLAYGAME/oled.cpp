/************************************  DO AN TOT NGHIEP  *****************************************/
/****************************** THIET BI CHOI GAME QUA BLUETOOTH *********************************/
/**************************************  LE QUANG HUY  *******************************************/
/**********************************  NGUYEN LE THANH HIEU  ***************************************/

#include "lib.h"

namespace main{
  namespace _OLED{  // Child space of Main space, this space declare OLED
    Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);   // OLED
    static const uint8_t image[1024] = {   // Array value of background image OLED 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x20, 0x60, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x60, 0x70, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xf8, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x01, 0xe3, 0xfc, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x01, 0xe3, 0xfc, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x18, 0x3f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x20, 0x80, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1c, 0x3c, 0xe0, 0x00, 0x00, 0x00, 0x08, 0x20, 0x81, 0x80, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1e, 0x38, 0x60, 0x00, 0x00, 0x00, 0x18, 0x60, 0x81, 0xc0, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0x30, 0x20, 0x00, 0x00, 0x00, 0x18, 0x20, 0xe3, 0xc0, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0x92, 0x20, 0x00, 0x00, 0x00, 0x08, 0x20, 0xe3, 0x80, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xe3, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe3, 0xe2, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe3, 0xe0, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x0f, 0xc7, 0x0e, 0x1c, 0x00, 0x00, 0x00, 0xe1, 0xe0, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x0f, 0x87, 0x8f, 0x1e, 0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x03, 0x8f, 0x87, 0x8f, 0x1e, 0x00, 0x00, 0x00, 0x20, 0x60, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x07, 0xe7, 0x87, 0x8f, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x03, 0xf3, 0x87, 0x8f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x01, 0xfb, 0x87, 0x8f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x01, 0xfd, 0x87, 0x8f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0xfe, 0x87, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x7f, 0x07, 0x0f, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x7f, 0x02, 0x0f, 0x1e, 0x00, 0x00, 0x26, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x3f, 0x80, 0x0f, 0x1e, 0x00, 0x00, 0x7e, 0xe0, 0x7b, 0xb0, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x1f, 0xe0, 0x0e, 0x1c, 0x00, 0x00, 0x6e, 0x46, 0x7b, 0xf0, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x4e, 0x40, 0x7e, 0xb0, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 0x46, 0x40, 0x6c, 0x90, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    void init(){
      if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        Serial.println(F("SSD1306 allocation failed"));
        for(;;);
      }
      delay(2000);
      testdrawroundrect();
      display.clearDisplay();
      display.ssd1306_command(SSD1306_SEGREMAP);
      display.ssd1306_command(SSD1306_COMSCANINC);
    }

    void status(String text){
      display.fillRoundRect(0, 0, 80, 8,0, SSD1306_BLACK);
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(0, 0);
      display.println(text);
      display.display(); 
    }

    void main(int percent){
      // Xóa khu vực pin cũ để vẽ lại (tránh bị chồng hình)
      // Khu vực pin giờ rộng hơn để chứa cả số (từ x=90 đến hết phải)
      display.fillRect(90, 0, 38, 10, BLACK); 
      
      drawBatteryIndicator(percent);
      display.drawBitmap(0, 0, image, 128, 64, 1);
      display.display(); 
    }

    void testdrawroundrect(void) {
      display.clearDisplay();
      for (int16_t i = 0; i < display.height() / 2 - 2; i += 2) {
        display.drawRoundRect(i, i, display.width() - 2 * i, display.height() - 2 * i,
                              display.height() / 4, SSD1306_WHITE);
        display.display();
        delay(1);
      }
      delay(2000);
    }
    void drawBatteryIndicator(int percentage) {
      // 1. Vẽ số % trước (Canh lề phải: x=90)
      display.setTextSize(1);
      display.setTextColor(WHITE);
      
      // Hiển thị số: "99%" hoặc "100%"
      if (percentage < 10) display.setCursor(100, 0);
      else if (percentage < 100) display.setCursor(94, 0);
      else display.setCursor(88, 0);
      
      display.print(percentage);
      display.print("%");

      // 2. Vẽ cục pin (Dời sang phải cùng: x=110 -> giữ nguyên hoặc chỉnh lại nếu cần)
      // Vẽ khung pin
      display.drawRect(114, 0, 14, 8, WHITE); // Khung nhỏ hơn chút (14x8)
      display.fillRect(128, 2, 2, 4, WHITE);  // Đầu cực dương nhỏ

      // Vẽ mức pin bên trong
      // Map 0-100% sang độ rộng 0-12px
      int batteryWidth = map(percentage, 0, 100, 0, 12);
      if (batteryWidth > 12) batteryWidth = 12;
      if (batteryWidth < 0) batteryWidth = 0;
      
      display.fillRect(115, 1, batteryWidth, 6, WHITE);
    }
  }
}
